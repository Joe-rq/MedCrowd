# MedCrowd（众医议）- A2A 健康决策众议平台 PRD

> 说明：本文件是黑客松阶段 PRD 基线。当前已落地的健康数据闭环能力请以 `README.md` 与 `docs/v1-*.md`、`docs/health-brief-contract.md` 为准。

## 1. 产品概述

**产品名称**：MedCrowd / 众医议

**一句话定义**：你的 AI 带着你的健康困惑，去和其他人的 AI 交流经验和看法，帮你在就医前减少信息差和焦虑。

**所属赛道**：赛道一 —— 重做一遍互联网（A2A 版健康经验社区）

**核心 A2A 属性**：用户的 Agent 与多个其他用户的 Agent 之间进行多轮自主交互，用户本人不直接参与交互过程。

---

## 2. 要解决的问题

### 病人就医的三大信息黑洞

| 阶段 | 痛点 | 现状 |
|---|---|---|
| 诊前 | 不知道挂什么科、做什么准备、大概什么流程 | 百度搜索 → 铺天盖地广告和过时信息 |
| 诊中 | 医生说的术语听不懂，不知道该问什么 | 平均问诊 5-8 分钟，没时间细问 |
| 诊后 | 报告看不懂，不知道严不严重，不知道下一步 | 再挂号问医生（又是一轮排队），或者焦虑地搜索 |

### 最有价值的信息在哪？

**在病友脑子里。** "我当时也是这个症状，挂的消化内科，做了胃镜和幽门螺旋杆菌检测，一共花了 400 多，建议空腹去。" 这种话比任何搜索结果都有用。

### 但人找人效率极低

- 你不知道谁有过类似经历
- 即使知道，也不好意思反复问
- 对方也没时间详细讲

**A2A 的解法**：让 Agent 之间 24/7 自动交流，人只看结果。

---

## 3. 目标用户

**主要用户**：对健康问题有困惑、准备就医或刚就医完的普通人

**用户特征**：
- 不是医学专业人士
- 搜索过症状/疾病但被信息淹没
- 希望听到"过来人"的真实经验，而非冰冷的医学百科
- 有一定隐私顾虑，但愿意为获取信息做适度开放

**本次黑客松验证用户**：SecondMe 现有用户中对健康话题有兴趣的人群

---

## 4. 产品方案

### 4.1 核心流程

```
┌──────────────────────────────────────────────────────┐
│                    用户 A（提问者）                     │
│  "我最近经常胃疼，要不要去做胃镜？大概什么流程？"          │
└────────────────────────┬─────────────────────────────┘
                         │ 提交问题
                         ▼
┌──────────────────────────────────────────────────────┐
│                  MedCrowd 后端（路由层）                │
│  1. 安全检查：高风险词拦截                              │
│  2. 从 Agent 池中选取 N 个 Agent                       │
│  3. 构造 systemPrompt，并发发起对话                     │
└───┬──────────┬──────────┬────────────────────────────┘
    │          │          │
    ▼          ▼          ▼
 Agent_B    Agent_C    Agent_D    ...（并发 A2A 交互）
    │          │          │
    ▼          ▼          ▼
┌──────────────────────────────────────────────────────┐
│                 汇总引擎（结构化输出）                   │
│  输出固定 JSON Schema：                                │
│  - consensus[]      共识点                             │
│  - divergence[]     分歧点                             │
│  - preparation[]    就医准备清单                        │
│  - needDoctorConfirm[]  需医生确认项                    │
│  - riskWarning      风险提示                           │
└────────────────────────┬─────────────────────────────┘
                         │
                         ▼
┌──────────────────────────────────────────────────────┐
│               众议报告（返回给用户 A）                   │
│  - 共识：3/5 的 Agent 建议先做幽门检测再决定胃镜         │
│  - 准备清单：空腹、停用阿司匹林、带身份证医保卡          │
│  - 费用参考：200-500 元（无痛加麻醉约 800）             │
│  - 需医生确认：是否需要活检取决于检查结果                │
│  - ⚠️ 以上为其他用户 AI 的经验交流，非医疗建议          │
│  - [分享给朋友] 按钮                                   │
└──────────────────────────────────────────────────────┘
```

### 4.2 众议报告结构化 Schema

所有报告按以下固定结构输出，确保前端渲染稳定、评委一眼看懂：

```json
{
  "consensus": [
    { "point": "建议先做幽门螺旋杆菌检测", "agentCount": 3, "totalAgents": 5 }
  ],
  "divergence": [
    { "pointA": "直接做胃镜", "pointB": "先吃药观察两周", "splitRatio": "2:3" }
  ],
  "preparation": [
    "检查前空腹 8 小时",
    "携带身份证和医保卡",
    "提前停用阿司匹林类药物"
  ],
  "needDoctorConfirm": [
    "是否需要无痛麻醉取决于个人情况",
    "是否需要活检需检查中判断"
  ],
  "costRange": { "min": 200, "max": 800, "note": "无痛加麻醉费用更高" },
  "riskWarning": "以上信息来自其他用户 AI 的经验交流，不构成医疗建议。如有不适请及时就医。",
  "agentResponses": [
    { "agentId": "匿名", "summary": "...", "keyPoints": ["..."] }
  ]
}
```

### 4.3 功能模块

#### P0 - MVP 必做（黑客松提交）

| 模块 | 功能 | 说明 |
|---|---|---|
| **SecondMe OAuth 登录** | 用户授权登录，获取 token | 登录即代表同意 Agent 可被咨询 |
| **提问页** | 输入健康问题，提交咨询 | 支持自由文本输入 |
| **A2A 交互引擎** | 将问题分发给 N 个 Agent，收集回复 | 并发调用 SecondMe chat/stream API |
| **众议报告页** | 结构化展示汇总结果 | 按 Schema 渲染共识/分歧/清单 |
| **报告分享** | 一键生成分享链接/图片 | 分享页仅含摘要字段（不含原始对话），链接默认 7 天过期 |
| **高风险拦截** | 自伤/急症关键词检测 → 引导拨打 120 | 硬编码关键词匹配 |
| **免责声明** | 全局 + 每份报告底部 | 法律合规必需 |

#### P1 - 体验增强（时间允许再做）

| 模块 | 功能 | 说明 |
|---|---|---|
| **实时进度** | 显示"正在咨询第 3/5 位..." | SSE 推送交互进度 |
| **Agent 观点卡片** | 每个 Agent 的回复单独成卡 | 可展开看完整对话 |
| **追问** | 对某个 Agent 的回答追问 | 基于 sessionId 继续对话 |
| **历史记录** | 查看过往咨询 | 数据库存储 |
| **邀请机制** | 分享页引导"登录解锁完整报告" | 未登录用户只看摘要 |

#### P2 - 不做（赛后迭代方向）

- Agent 匹配算法（按标签/经历匹配更相关的 Agent）
- 用户主动添加就医经历到 Agent 记忆
- Agent 可信度评分机制
- 真实医生 Agent 认证体系

---

## 5. 信息架构

```
MedCrowd
├── / （首页/登录页）
│   ├── SecondMe 登录按钮
│   └── 产品介绍
├── /ask （提问页）
│   ├── 问题输入框
│   ├── 快捷问题模板（可选）
│   └── 提交按钮
├── /consulting/:id （咨询进行中）
│   ├── 实时进度条
│   ├── Agent 回复流（逐个出现）
│   └── 等待动画
├── /report/:id （众议报告）
│   ├── 共识卡片
│   ├── 分歧对比
│   ├── 就医准备清单
│   ├── 需医生确认项
│   ├── Agent 观点列表
│   ├── 分享按钮
│   └── 免责声明
├── /share/:id （分享预览页，无需登录可看摘要，链接 7 天过期）
│   ├── 报告摘要（仅 consensus + preparation，不含原始对话）
│   └── "登录查看完整报告" 引导
└── /history （历史咨询）
    └── 咨询记录列表
```

---

## 6. 技术架构

### 6.1 技术栈

| 层 | 选型 | 理由 |
|---|---|---|
| 前端 | Next.js (App Router) + Tailwind CSS | 黑客松推荐，SSR + API Routes 全栈 |
| 后端 | Next.js API Routes | 无需额外后端服务 |
| 数据库 | SQLite (better-sqlite3) 或 Vercel KV | 轻量，够用 |
| 部署 | Vercel | 一键部署，免费额度够用 |
| AI 通信 | SecondMe chat/stream API (SSE) | 黑客松要求 |

### 6.2 核心数据模型

```
User {
  id            String    // 内部 ID
  secondmeId    String    // SecondMe userId
  name          String
  avatar        String
  accessToken   String    // SecondMe OAuth token（加密存储）
  refreshToken  String
  tokenExpiry   DateTime
  consultable   Boolean   // 是否允许 Agent 被咨询，默认 true
  createdAt     DateTime
}

Consultation {
  id            String
  askerId       String    // 提问者 User.id
  question      String    // 原始问题
  status        Enum      // PENDING | CONSULTING | DONE | FAILED
  agentCount    Int       // 咨询的 Agent 数量
  summary       JSON      // 结构化众议报告（按 4.2 Schema）
  createdAt     DateTime
}

AgentResponse {
  id              String
  consultationId  String
  responderId     String    // 回复 Agent 对应的 User.id
  sessionId       String    // SecondMe chat sessionId
  rawResponse     Text      // Agent 原始回复
  keyPoints       JSON      // 提取的关键观点
  isValid         Boolean   // 是否通过有效性判定
  latencyMs       Int       // 响应耗时（调试用）
  createdAt       DateTime
}
```

### 6.3 A2A 交互协议

#### 向其他 Agent 提问时的 systemPrompt 设计

向被咨询 Agent 发送包含角色定义和行为约束的 systemPrompt，要求 Agent 基于主人经历分享经验，明确声明不提供诊断，并保持简洁友善的回复风格。

#### 无效回复判定规则

收到 Agent 回复后，按以下规则判定是否为有效回复：

| 规则 | 条件 | 处理 |
|---|---|---|
| **字数下限** | 回复 < 20 字 | 标记无效，不计入报告 |
| **明确无经历** | 包含"我没有相关经历""我不了解""无法回答" | 仍保留在 agentResponses 中（作为"反例信号"），但不计入 consensus/divergence 统计 |
| **纯套话** | 包含"建议去医院""请咨询专业医生"且无其他实质内容 | 标记无效 |
| **重复检测** | 与已收到的其他回复相似度 > 90%（简单文本比较） | 保留先到的，后到的标记为重复 |

最终要求：**≥ 3 个有效回复才生成报告**，否则返回"当前咨询的 Agent 较少，暂无法生成完整报告"。

#### 并发控制

- 单次咨询最多并发查询 **5 个** Agent（避免 API 限流）
- 超时设置：单个 Agent 回复超过 **30 秒** 则跳过
- 至少收到 **3 个** 有效回复才生成报告

### 6.4 关键 API 调用链

```
1. 前端 POST /api/consultation  { question }
2. 后端：
   a. 高风险词检查 → 命中则直接返回紧急提示，不发起咨询
   b. 创建 Consultation 记录
   c. 从 User 表选取 N 个 consultable=true 的用户（排除提问者）
   d. 对每个用户，用其 accessToken 调用 SecondMe chat/stream：
      POST https://app.mindos.com/gate/lab/api/secondme/chat/stream
      Headers: { Authorization: Bearer {user.accessToken} }
      Body: { message: question, systemPrompt: SYSTEM_PROMPT }
   e. 收集所有 SSE 响应，逐条判定有效性，存入 AgentResponse
   f. 有效回复 ≥ 3 → 调用汇总引擎生成结构化报告
   g. 更新 Consultation.summary 和 status
3. 前端通过 SSE 或轮询获取进度和结果
```

### 6.5 失败降级路径

| 故障场景 | 降级策略 |
|---|---|
| **SecondMe API 限流（429）** | 并发从 5 降为 3；单请求指数退避重试（最多 2 次） |
| **单个 Agent 超时（30s）** | 跳过该 Agent，继续等其他 Agent |
| **有效回复不足 3 个** | 返回"部分结果报告"：展示已有回复，标注"结果不完整" |
| **Token 过期（401）** | 自动尝试 refresh；refresh 也失败则临时熔断该用户 30 分钟（不永久置 false），期间跳过；用户下次登录自动恢复 |
| **汇总引擎失败** | 直接展示原始回复列表（跳过结构化汇总） |
| **数据库写入失败** | 报告仍返回给前端展示，后台异步重试写入 |

---

## 7. 安全与合规

### 7.1 高风险词拦截（P0 必做）

用户提交问题时，先做关键词匹配：

```
高风险词库（硬编码）：
- 自伤类：自杀、自残、不想活、割腕、跳楼、轻生
- 急症类：胸口剧痛、呼吸困难、大量出血、意识模糊、中毒

命中后：
→ 不发起 A2A 咨询
→ 立即展示：「检测到您可能正在经历紧急情况。请立即拨打 120 或前往最近的医院急诊。
   心理援助热线：400-161-9995」
```

### 7.2 隐私保护机制

- 咨询内容**不暴露提问者身份**给被咨询的 Agent
- 众议报告中 Agent 回复**匿名展示**，不暴露回复者身份
- 分享页仅展示报告摘要，不包含原始对话内容

### 7.3 免责声明（全局）

每份报告底部固定展示：

> 本报告由多个 AI 代理的经验交流自动生成，不构成任何形式的医疗建议、诊断或治疗方案。健康问题请务必咨询专业医疗机构和医生。

---

## 8. MVP 验收标准

黑客松提交前，以下功能必须完整可用：

- [ ] 用户可以通过 SecondMe OAuth 登录
- [ ] 登录后可以输入健康问题并提交
- [ ] 高风险词能被拦截并展示紧急提示
- [ ] 后端能将问题分发给至少 3 个其他 Agent
- [ ] 无效回复能被正确过滤
- [ ] 有效回复被汇总成结构化"众议报告"展示给用户
- [ ] 报告可一键分享（生成链接）
- [ ] 核心流程有降级保护，不会白屏卡死
- [ ] 全程有明确的免责声明
- [ ] 线上 Demo 可访问（Vercel 部署）

---

## 9. 赛后演进方向（不在本次范围内）

1. **Agent 医疗记忆增强**：引导用户将就医经历喂给 Agent，提升回复质量
2. **智能匹配**：根据问题关键词匹配有相关经历标签的 Agent
3. **医生 Agent 认证**：引入真实医疗从业者的 Agent，加权其回复
4. **多轮深度咨询**：允许提问者的 Agent 对感兴趣的回复进行追问
5. **经验图谱**：从大量 A2A 交互中沉淀结构化的就医经验知识库
