# MedCrowd（众医议）项目详情

## 🏆 参赛信息

- **赛事**: SecondMe A2A Hackathon
- **作品名称**: MedCrowd（众医议）
- **项目定位**: A2A 健康决策众议平台

---

## 📌 一句话介绍

> **你的 AI 带着你的困惑，去咨询众人的 AI。**

MedCrowd 让用户的 AI Agent 代表用户，与其他用户的 AI Agent 进行 24/7 自动交流，实现私密、匿名的健康经验众议。

---

## 🎯 解决什么痛点

### 传统健康论坛的问题

| 痛点 | 具体表现 |
|------|----------|
| **隐私顾虑** | 不愿公开详细描述症状，怕被熟人看到 |
| **噪音过大** | 需要筛选大量无关回复，效率低 |
| **无法追问** | 静态回答难以澄清，互动性差 |
| **时间错配** | 不知道谁有过类似经历，即使知道也不好意思反复问 |

### 病友经验的珍贵性

> "我当时也是这个症状，挂的消化内科，做了胃镜和幽门螺旋杆菌检测，一共花了 400 多，建议空腹去。"

这类真实经验不在搜索引擎里，而在病友脑子里。但获取门槛极高。

---

## 💡 核心解法

```
你输入问题 → 你的 AI 代你出发 → 同时咨询多个病友的 AI → 
收集经验 → 互相评议 → 生成结构化报告
```

### 为什么用 A2A？

1. **Agent 代理用户** —— 你的 SecondMe AI 理解你的完整健康背景
2. **多 Agent 并发** —— 同时咨询最多 5 个其他用户的 AI
3. **反应轮互评** —— Agent 之间可以澄清、对比、深入讨论
4. **匿名聚合** —— 所有交互匿名进行，报告中不暴露 Agent 身份

---

## 🚀 完整功能流程

| 步骤 | 功能 | 技术亮点 |
|------|------|----------|
| 1 | SecondMe OAuth 登录 | 授权 AI Agent 参与咨询网络 |
| 2 | 输入健康问题 | 5-500 字自由输入 + 快捷问题 |
| 3 | 意图分诊 | Act API 自动识别问题类型（诊前/诊中/诊后/用药/心理） |
| 4 | 安全拦截 | 自伤/急症关键词自动拦截，引导专业援助 |
| 5 | 多 Agent 咨询 | 并发查询最多 5 个其他用户的 AI |
| 6 | 反应轮互评 | 第一轮回复 ≥2 时，触发第二轮 Agent 评议 |
| 7 | 结构化报告 | 共识、分歧、就医准备、费用参考、需医生确认项 |
| 8 | 分享传播 | `/share/[id]` 一键分享，好友免登录查看摘要 |

### 报告结构

- **共识观点**: 多数 Agent 认同的经验，标注支持比例
- **就医准备清单**: 实用准备事项（空腹、带病历等）
- **费用参考**: 基于经验的费用范围
- **需医生确认项**: Agent 建议需专业医生确认的事项
- **Agent 互评**: 反应轮中的评议内容（如有）
- **风险声明**: 明确标注"不构成医疗建议"

---

## 🛡️ 安全设计

| 风险类型 | 拦截策略 |
|----------|----------|
| 自伤倾向 | 9 个关键词（自杀、自残等）→ 返回心理援助热线 |
| 急症风险 | 8 个关键词（胸口剧痛、呼吸困难等）→ 提示拨打 120 |
| 医疗免责声明 | 全局 + 报告页 + 分享页 三处声明 |
| OAuth 安全 | state CSRF 防护 + iron-session 加密会话 |

---

## 🏗️ 技术架构

### 技术栈

**Frontend**
![Next.js](https://img.shields.io/badge/Next.js-16-black?logo=next.js) ![React](https://img.shields.io/badge/React-19-61DAFB?logo=react&logoColor=white) ![TypeScript](https://img.shields.io/badge/TypeScript-5-3178C6?logo=typescript) ![Tailwind CSS](https://img.shields.io/badge/Tailwind_CSS-4-06B6D4?logo=tailwindcss)

**Backend**
![Next.js API](https://img.shields.io/badge/Next.js_API_Routes-black?logo=next.js) ![Iron Session](https://img.shields.io/badge/iron--session-encrypted_cookies-blue)

**AI / A2A**
![SecondMe](https://img.shields.io/badge/SecondMe-OAuth_2.0-6C47FF?logo=data:image/svg+xml;base64,) ![Chat API](https://img.shields.io/badge/Chat_API-SSE_Streaming-6C47FF) ![Act API](https://img.shields.io/badge/Act_API-Intent_Classification-6C47FF)

**Storage**
![Vercel KV](https://img.shields.io/badge/Vercel_KV-Upstash_Redis-000000?logo=vercel)

**Deploy**
![Vercel](https://img.shields.io/badge/Vercel-Serverless-000000?logo=vercel)

### 架构图

```
用户浏览器
    │
    ▼
┌─────────────────────────────────────────────────┐
│              Next.js 16 (App Router)             │
│                                                   │
│  ┌─────────┐  ┌──────────┐  ┌─────────────────┐ │
│  │  OAuth   │  │   Ask    │  │  Report / Share  │ │
│  │  Login   │  │   Page   │  │     Pages        │ │
│  └────┬─────┘  └────┬─────┘  └───────┬─────────┘ │
│       │              │                │            │
│  ┌────▼─────────────▼────────────────▼──────────┐│
│  │              API Routes                        ││
│  │  /auth/*  /consultation  /act/triage           ││
│  └────┬──────────┬──────────────┬────────────────┘│
│       │          │              │                  │
│  ┌────▼───┐ ┌───▼────┐  ┌─────▼──────┐          │
│  │Session │ │ Engine │  │  Safety    │          │
│  │(iron)  │ │(A2A)   │  │  Check     │          │
│  └────────┘ └───┬────┘  └────────────┘          │
│                 │                                  │
│         ┌───────▼────────┐                        │
│         │  SecondMe API  │                        │
│         │  Chat + Act    │                        │
│         └───────┬────────┘                        │
│                 │                                  │
│         ┌───────▼────────┐                        │
│         │   Vercel KV    │                        │
│         │  (Upstash)     │                        │
│         └────────────────┘                        │
└───────────────────────────────────────────────────┘
```

---

## 🔄 A2A 交互流程详解

```
用户提问
  │
  ▼
Act API 意图分诊 ──→ 调整 System Prompt
  │
  ▼
安全关键词检查 ──→ 命中则拦截并返回援助信息
  │
  ▼
选取可咨询 Agent（排除自己、熔断用户、token 过期用户）
  │
  ▼
═══════════════════════════════════
  第一轮：并发咨询（最多 5 个 Agent，30s 超时）
═══════════════════════════════════
  │
  ▼
回复验证（过短过滤、无经验标记、套话过滤、重复检测）
  │
  ▼
门控判断：有效回复 >= 2 ?
  │
  ├─ YES ──→ ═══════════════════════════════════
  │            第二轮：反应轮互评（15s 超时）
  │            Agent 回应彼此观点
  │           ═══════════════════════════════════
  │                │
  ├─ NO ───→ 跳过，标注"单轮汇总"
  │
  ▼
生成结构化报告（共识提取、费用提取、准备清单）
  │
  ▼
返回报告页 ──→ 可分享
```

---

## 🎨 A2A 创新点（评分维度对齐）

| 评分维度 | 权重 | MedCrowd 体现 |
|----------|------|---------------|
| **A2A 创新** | 30% | Agent 代表用户多轮咨询；AI-to-AI 动态协商；结构化共识提取 |
| **综合评估** | 30% | 不仅给答案，还给共识度、分歧点、就医准备清单、风险提示 |
| **完整性** | 20% | 端到端流程：OAuth → 提问 → 咨询 → 报告 → 分享；完整 UI 和错误处理 |
| **增长潜力** | 20% | `/share/[id]` 分享机制实现病毒传播；可扩展至更多专科领域 |

### 相比简单 Fan-out 的优势

| 特性 | 简单并行查询 | MedCrowd A2A |
|------|-------------|--------------|
| 单轮查询 | ✅ | ✅ |
| 多轮互评 | ❌ | ✅ 反应轮 |
| 共识提取 | ❌ | ✅ 结构化报告 |
| 匿名保护 | ⚠️ | ✅ 全程匿名 |
| 经验沉淀 | ❌ | ✅ 可回放报告 |

---

## 📱 使用场景示例

### 场景 1：诊前咨询
> "最近胃部不适，需要做胃镜吗？"

- **分诊**: 诊前咨询
- **共识**: "建议先观察 1-2 周，如无改善再做胃镜"
- **准备清单**: 空腹、带医保卡、带既往病历
- **费用参考**: 普通胃镜 200-400 元，无痛 600-800 元

### 场景 2：报告解读
> "体检显示甲状腺结节 3 类，严重吗？"

- **分诊**: 诊后咨询
- **共识**: "3 类多为良性，建议定期复查，无需过度担心"
- **需确认**: 具体结节大小、边界清晰度需医生判断

---

## 🌱 增长策略

### 分享传播闭环

```
用户获得报告 → 点击分享 → 生成分享链接 (/share/[id])
                 ↓
好友访问分享页 ← 社交传播 ← 看到摘要（共识+准备清单）
     ↓
引导注册/登录 ← CTA 按钮 "查看完整报告"
     ↓
新用户提问 → 新报告 → 继续分享...
```

**分享页特点**:
- 无需登录即可访问
- 只展示共识观点和就医准备清单（保护隐私）
- 隐藏详细回复（引导登录）
- 醒目 CTA 引导新用户注册

---

## 🔧 降级与容错

| 场景 | 处理方式 |
|------|----------|
| 单个 Agent 超时 | 跳过该 Agent，继续处理其他回复 |
| Token 过期 | 自动刷新；刷新失败则熔断 30 分钟 |
| 有效回复不足 3 个 | 生成 PARTIAL 报告，标注"结果不完整" |
| 有效回复为 0 | 返回 FAILED，提示稍后重试 |
| SecondMe API 不可用 | DEMO_MODE 返回预置回复，保证可演示 |
| Act API 不可达 | 规则兜底分诊 |

---

## 📊 项目数据

| 指标 | 数值 |
|------|------|
| 核心模块 | 9 个 (engine, secondme, db, summary, act, validator, safety, session) |
| API 路由 | 8 个 |
| 页面 | 4 个 (Landing, Ask, Report, Share) |
| 单元测试 | ✅ 覆盖核心模块 |
| 部署 | ✅ Vercel 生产环境 |

---

## 🔮 未来规划

### 短期优化
- [ ] 完善分歧检测语义分析
- [ ] 优化反应轮 UI 展示
- [ ] 增加更多快捷问题模板

### 中长期扩展
- [ ] 垂直科室细分（儿科、妇科、骨科等）
- [ ] 历史报告趋势分析
- [ ] 对接医院预约系统
- [ ] 多语言支持

---

## 🙏 致谢

感谢 SecondMe 团队提供的 A2A 协议支持和 Hackathon 机会。

---

**项目链接**:
- Demo: https://med-crowd.vercel.app
- GitHub: https://github.com/Joe-rq/MedCrowd

**联系我们**:
- 开发者: Joe-rq
- 邮箱: [qrq-hit@foxmail.com]
